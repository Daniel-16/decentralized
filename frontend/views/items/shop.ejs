<%- include('../partials/header') %>
<div class="top-area">
    <div class="grid_frame">
        <div class="container_grid clearfix">
            <div class="grid_12">
                <h2 class="page-title">Items Marketplace</h2>
            </div>
        </div>
    </div>
</div>
<div class="grid_frame page-content">
  <div class="container_grid">
    <div class="mod-grp-coupon block">
      <div class="brand-top-info clearfix">
        <div class="wrap-for-res">
          <div class="grid_3 wrap-brand-logo">
            <div class="brand-logo">
              <h4>KooponCraft</h4>
            </div>
          </div>
          <div class="grid_2 make-right">
            <div class="ta-c">
              <span class="star-rate"><span style="width: 74%"></span></span>
              <a class="btn btn-orange btn-follow-brand" href="#"
                >Rate us now!!!</a
              >
            </div>
          </div>
        </div>
        <div class="grid_7">
          <div class="brand-desc">
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. In quis
            metus non nunc iaculis dapibus. Nullam tempus accumsan metus vitae
            facilisis. Nullam non faucibus nisi, nec auctor neque. Ut consequat
            consequat purus. Sed vestivbulum viverra nulla vel fermentum. Fusce
            luctus ultrices lorem, in placerat nibh adipiscing ut.
          </div>
        </div>
      </div>
      <div class="block-content list-coupon clearfix">
        <div id="itemsContainer"></div>
        <!--end: .coupon-item -->
      </div>
    </div>
    <!--end block: Featured Coupons-->
  </div>
</div>

<script
  src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>



<script>
$(document).ready(function () {
  // fetch and display items
  function loadItems() {
    $.ajax({
      url: "/api/getItems",
      method: "GET",
      success: function (response) {
        if (response.success) {
          const items = response.items;
          let itemsHTML = "";
          items.forEach((item) => {
            itemsHTML += `
            <div class="coupon-item grid_3">
              <div class="coupon-content">
                <div class="img-thumb-center">
                  <div class="wrap-img-thumb">
                    <span class="ver_hold"></span>
                    <a href="#" class="ver_container">
                      <img src="/assets/images/ex/01_01.jpg" alt="${item.nameOfItem}" />
                    </a>
                  </div>
                </div>
                <div class="coupon-price">$${item.priceOfItem}</div>
                <div class="coupon-brand">${item.nameOfItem}</div>
                <div class="coupon-desc">
                  Buy now and stand a chance to ...
                </div>
                <br>
                <a class="btn btn-blue btn-take-coupon" href="#" data-item-id="${item._id}">Purchase</a>
              </div>
            </div>
            `;
          });

          // populate items to the #itemsContainer
          $("#itemsContainer").html(itemsHTML);

          // connect click handler to dynamically created buttons
          attachPurchaseHandlers();
        } else {
          $("#itemsContainer").html("<p>No items found.</p>");
        }
      },
      error: function (jqXHR, textStatus, errorThrown) {
        $("#itemsContainer").html("<p>Error fetching items.</p>");
      },
    });
  }
  // end: fetch and display items

  //  handle purchase 
  function attachPurchaseHandlers() {
    $('.btn-take-coupon').off('click').on('click', function(event) {
      event.preventDefault(); 

      const itemId = $(this).data('item-id'); // get the item id from data attribute
      const quantity = 1; // say quantity is always 1 for simplicity

      // get the token from localStorage
      const token = localStorage.getItem("token");

      $.ajax({
        url: '/api/purchaseItem', 
        method: 'POST',
        contentType: 'application/json', // very important!
        data: JSON.stringify({
          itemId: itemId,
          quantity: quantity
        }),
        headers: {
          Authorization: `Bearer ${token}` 
        },
        success: function(response) {
          if (response.success) {
            // alert('Purchase successful!');
            toastr.success("Successfully purchased 1 unit!");
          } else {
            alert('Error: ' + response.error);
          }
        },
        error: function(jqXHR, textStatus, errorThrown) {
          alert('Error: ' + errorThrown);
        }
      });
    });
  }
  //  end: handle purchase 

  // load items when ready
  loadItems();
});
</script>


<%- include('../partials/footer') %>
