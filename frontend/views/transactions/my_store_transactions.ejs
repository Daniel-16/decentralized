<%- include('../partials/header') %>
<div class="top-area">
  <div class="grid_frame">
    <div class="container_grid clearfix">
      <div class="grid_12">
        <h2 class="page-title">My Store Transactions</h2>
        <!-- <h6></h6> -->
      </div>
    </div>
  </div>
</div>
<div class="grid_frame page-content">
  <div class="container_grid">
    <div class="layout-2cols pt-hight clearfix">
      <div class="grid_8 content">
        <div class="mod-list-article">
          <div class="list-article">
            <!--end: article-item -->

            <div id="transactionsContainer"></div>
          </div>
        </div>
        <!--end: .mod-list-article -->
      </div>
      <div class="grid_4 sidebar">
            <div class="mod-search block">
                <h3 class="title-block">Find a transaction</h3>
                <div class="block-content">
                    <label class="lbl-wrap" for="sys_search_coupon_code">
                        <input disabled class="keyword-search" id="sys_search_coupon_code" type="search" placeholder="Search"/>
                        <input disabled type="submit" class="btn-search" value="">
                    </label>
                </div>
            </div>
            <!--end: .mod-search -->
            <div id="additionalInfoContainer"></div> 

        </div>
    </div>
  </div>
</div>

<script
  src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- get all transactions -->
<script>
$(document).ready(function () {
  console.log("Document ready");

  // Function to fetch and display store transactions
  function loadTransactions() {
    const token = localStorage.getItem("token");

    $.ajax({
      url: "/api/checkStorePurchases", // Adjust endpoint if necessary
      method: "GET",
      headers: {
        Authorization: `Bearer ${token}`, 
      },
      success: function (response) {
        console.log(response);
        if (response.success) {
          const transactions = response.purchases;
          let transactionsHTML = "";

          transactions.forEach((transaction) => {
            const purchaseDate = new Date(transaction.purchaseDate);
            const day = purchaseDate.getDate();
            const monthYear = purchaseDate.toLocaleDateString("en-GB", {
              month: "short",
              year: "numeric",
            });
            const time = purchaseDate.toLocaleTimeString("en-GB", {
              hour: "2-digit",
              minute: "2-digit",
            });

            transactionsHTML += `
              <div class="article-item">
                <div class="flex">
                  <div class="thumb-left wrap-date-post">
                    <div class="date">
                      <span class="day">${transaction.quantity}</span>
                    </div>
                    <a class="btn-more" href="#">$${transaction.totalPrice.toFixed(
                      2
                    )}</a>
                  </div>
                  <div class="flex-body">
                    <p class="art-title rs"><a href="#">${
                      transaction.itemName
                    }</a></p>
                    <p class="rs art-desc">Purchased ${
                      transaction.quantity
                    } item(s) by ${
                      transaction.buyerName
                    }. Total cost: $${transaction.totalPrice.toFixed(2)}.</p>
                  </div>
                </div>
              </div>
            `;
          });

          // Append transactions to the #transactionsContainer
          $("#transactionsContainer").html(transactionsHTML);

          // Style and append additional information
          const additionalInfoHTML = `
            <div class="summary" style="padding: 20px; margin-top: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9;">
              <h3 style="margin-bottom: 15px; font-size: 1.5em; color: #333;">Store Summary</h3>
              <p style="margin: 5px 0; font-size: 1.2em;"><strong>Total Sales:</strong> $${response.totalSales.toFixed(2)}</p>
              <p style="margin: 5px 0; font-size: 1.2em;"><strong>Total Items Sold:</strong> ${response.totalItems}</p>
              <p style="margin: 5px 0; font-size: 1.2em;"><strong>Total Transactions:</strong> ${response.totalTransactions}</p>
              <p style="margin: 5px 0; font-size: 1.2em;"><strong>Highest Buyer:</strong> ${response.highestBuyer.buyerName} (Spent $${response.highestBuyer.totalPurchase.toFixed(2)})</p>
            </div>
          `;
          
          // Append additional information to a designated container
          $("#additionalInfoContainer").html(additionalInfoHTML);

        } else {
          $("#transactionsContainer").html("<p>No transactions found.</p>");
          $("#additionalInfoContainer").html(""); // Clear additional info
        }
      },
      error: function (jqXHR, textStatus, errorThrown) {
        $("#transactionsContainer").html("<p>Error fetching transactions.</p>");
        $("#additionalInfoContainer").html(""); // Clear additional info
      },
    });
  }

  // Load transactions when the document is ready
  loadTransactions();
});

</script>
<!-- end: get all transactions -->


<%- include('../partials/footer') %>
